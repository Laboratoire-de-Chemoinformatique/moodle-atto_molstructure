YUI.add("moodle-atto_molstructure-button",function(e,t){var n="atto_molstructure",r=M.cfg.wwwroot+"/lib/editor/atto/plugins/molstructure/canvas.html",i="canvas",s="atto_molstructure",o="submit",u={INPUTSUBMIT:"atto_media_urlentrysubmit",HGT:"height: 68vh;",WDT:"width: 48vw;"},a='<iframe src="{{isource}}" id="{{iframeID}}" style="{{CSS.HGT}}{{CSS.WDT}}"><p>{{get_string "iframeprb" component}}</p></iframe><div style="text-align:center"><button class="{{CSS.INPUTSUBMIT}}" id ="{{submitID}}" style="{{selectalign}}">{{get_string "insert" component}}</button></div>';e.namespace("M.atto_molstructure").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_usercontextid:null,_filename:null,initializer:function(e){this._usercontextid=e.usercontextid,this._filename=(new Date).getTime();var t=this.get("host"),n=t.get("filepickeroptions");if(!n.image||!n.image.itemid)return;this._itemid=n.image.itemid;if(this.get("disabled"))return;this.addButton({icon:"icon",iconComponent:"atto_molstructure",buttonName:"icon",callback:this._displayDialogue,callbackArgs:"icon"})},_displayDialogue:function(e,t){var s=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),height:"94vh",width:"50vw",focusAfterHide:t});e.preventDefault(),s.after("visibleChange",function(){var e=s.getAttrs();e.visible===!1&&setTimeout(function(){s.reset()},5)});var o=this._getFormContent(t);s.set("bodyContent",o),document.getElementById(i).src=r,s.centerDialogue(),s.show(),this.markUpdated()},_getFormContent:function(t){var s=e.Handlebars.compile(a),f=e.Node.create(s({elementid:this.get("host").get("elementid"),CSS:u,component:n,clickedicon:t,isource:r,iframeID:i,submitID:o}));return this._form=f,this._form.one("."+u.INPUTSUBMIT).on("click",this._getImgURL,this),this._form.one("#"+i).on("load",this._changeLangString,this),f},_uploadFile:function(e,t){var n=new XMLHttpRequest,r="datatype=uploadfile";r+="&filedata="+encodeURIComponent(e),r+="&requestid="+t,r+="&itemid="+this._itemid,r+="&sesskey="+M.cfg.sesskey,n.open("POST",M.cfg.wwwroot+"/lib/editor/atto/plugins/molstructure/structurefilelib.php"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.setRequestHeader("Cache-Control","no-cache"),n.setRequestHeader("Content-length",r.length),n.send(r)},_changeLangString:function(e){function t(){var e=$("#"+i),t=e.contents(),r=t.find("#button-size-button");r[0].firstChild.data=M.util.get_string("resize",n);var s=t.find("#label_height_input_molstructure");s[0].firstChild.data=M.util.get_string("height",n);var o=t.find("#label_width_input_molstructure");o[0].firstChild.data=M.util.get_string("width",n)}e.preventDefault(),t()},_getImgURL:function(e){function o(e){var n=$("#"+i),o=n.contents(),u=o.find("#sketcher-viewer-atto"),a=u[0].toDataURL("image/svg");s._uploadFile(a,t);var f=M.cfg.wwwroot,l=f+"/draftfile.php/"+s._usercontextid+"/user/draft/"+s._itemid+"/"+e;r='<img name="pict" src="'+l+'" alt="ChemDoodle PNG"/>',s.editor.focus(),s.get("host").insertContentAtFocusPoint(r),s.markUpdated()}e.preventDefault();var t=(new Date).getTime()+"-"+Math.round(Math.random()*1e4),n="upfile_"+t+".png",r="",s=this;o(n),this.getDialogue({focusAfterHide:null}).hide()}},{ATTRS:{disabled:{value:!1},usercontextid:{value:null}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
